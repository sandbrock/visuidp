# Requirements Document

## Introduction

This document specifies requirements for adding API key authentication to the Internal Developer Platform (IDP). The system currently uses OAuth2 Proxy with AWS Identity Center for user authentication. This feature will enable programmatic access through API keys while maintaining security and auditability. Users will be able to generate personal API keys tied to their credentials, while administrators can create system-level API keys that persist beyond individual user tenure. API keys will support automatic expiration and rotation capabilities.

## Glossary

- **API_Key_System**: The authentication subsystem that manages API key generation, validation, storage, and lifecycle
- **User_API_Key**: An API key generated by and tied to a specific user's credentials
- **System_API_Key**: An API key generated by an administrator that persists independently of any individual user account
- **Key_Rotation**: The process of replacing an existing API key with a new one while maintaining service continuity
- **Key_Expiration**: The automatic invalidation of an API key after a specified time period
- **OAuth2_Proxy**: The existing authentication layer that handles user SSO authentication
- **IDP_API**: The Quarkus backend application that processes API requests

## Requirements

### Requirement 1

**User Story:** As a developer, I want to generate personal API keys for my account, so that I can authenticate programmatic access to the IDP API without interactive login

#### Acceptance Criteria

1. WHEN a user requests API key generation through the API, THE API_Key_System SHALL create a unique API key associated with the user's account
2. WHEN an API key is generated, THE API_Key_System SHALL return the key value to the user exactly once
3. WHEN an API key is stored, THE API_Key_System SHALL store a cryptographic hash of the key rather than the plaintext value
4. WHEN a user views their API keys, THE API_Key_System SHALL display key metadata including creation date, last used date, expiration date, and key name without revealing the key value
5. WHEN a user has multiple API keys, THE API_Key_System SHALL allow the user to manage each key independently

### Requirement 2

**User Story:** As an administrator, I want to generate system-level API keys, so that automated systems can access the IDP API even when individual administrators leave the organization

#### Acceptance Criteria

1. WHEN an administrator requests system API key generation, THE API_Key_System SHALL create a unique API key not tied to any individual user account
2. WHEN a system API key is created, THE API_Key_System SHALL record which administrator created the key for audit purposes
3. WHEN an administrator leaves the organization, THE API_Key_System SHALL maintain all system API keys they created in active status
4. WHERE an administrator has appropriate permissions, THE API_Key_System SHALL allow viewing and managing all system API keys
5. WHEN a system API key is used, THE API_Key_System SHALL log the activity with the system key identifier rather than a user identifier
6. WHEN an administrator accesses the admin API key management interface, THE API_Key_System SHALL only allow creation of system-level API keys

### Requirement 3

**User Story:** As a security-conscious user, I want API keys to automatically expire after a configurable period, so that unused or forgotten keys do not pose a long-term security risk

#### Acceptance Criteria

1. WHEN a user creates an API key, THE API_Key_System SHALL allow the user to specify an expiration period from predefined options including 30 days, 90 days, 180 days, and 1 year
2. WHEN an API key reaches its expiration date, THE API_Key_System SHALL automatically invalidate the key
3. WHEN an expired API key is used for authentication, THE API_Key_System SHALL reject the request with an appropriate error message
4. WHEN an API key is approaching expiration within 7 days, THE API_Key_System SHALL mark the key with a warning status in the user interface
5. WHERE no expiration is specified during creation, THE API_Key_System SHALL apply a default expiration period of 90 days

### Requirement 4

**User Story:** As a developer, I want to rotate my API keys, so that I can replace potentially compromised keys without service interruption

#### Acceptance Criteria

1. WHEN a user requests key rotation, THE API_Key_System SHALL generate a new API key with the same permissions and metadata as the original
2. WHEN a new key is generated through rotation, THE API_Key_System SHALL maintain the old key in active status for a grace period of 24 hours
3. WHEN the grace period expires, THE API_Key_System SHALL automatically revoke the old key
4. WHEN both old and new keys are active during the grace period, THE API_Key_System SHALL accept authentication requests using either key
5. WHEN key rotation is initiated, THE API_Key_System SHALL return the new key value to the user exactly once

### Requirement 5

**User Story:** As a developer, I want to authenticate API requests using my API key, so that I can access the IDP API programmatically

#### Acceptance Criteria

1. WHEN a request includes a valid API key in the Authorization header, THE IDP_API SHALL authenticate the request with the associated user or system identity
2. WHEN a request includes an API key, THE API_Key_System SHALL validate the key against stored hashes within 100 milliseconds
3. WHEN an API key is successfully used, THE API_Key_System SHALL update the last used timestamp for that key
4. WHEN an invalid API key is provided, THE IDP_API SHALL reject the request with HTTP status 401 and an appropriate error message
5. WHEN a request is authenticated via API key, THE IDP_API SHALL apply the same authorization rules as OAuth2-authenticated requests

### Requirement 6

**User Story:** As a user, I want to revoke my API keys immediately, so that I can invalidate compromised or unnecessary keys

#### Acceptance Criteria

1. WHEN a user requests revocation of their API key, THE API_Key_System SHALL immediately invalidate the specified key
2. WHEN a revoked API key is used for authentication, THE API_Key_System SHALL reject the request with HTTP status 401
3. WHEN an administrator revokes a system API key, THE API_Key_System SHALL immediately invalidate the key regardless of expiration date
4. WHEN a key is revoked, THE API_Key_System SHALL record the revocation timestamp and the user who performed the revocation
5. WHEN a revoked key is viewed, THE API_Key_System SHALL display the key status as revoked with the revocation timestamp

### Requirement 7

**User Story:** As a security administrator, I want to audit API key usage, so that I can monitor for suspicious activity and ensure compliance

#### Acceptance Criteria

1. WHEN an API key is created, THE API_Key_System SHALL log the creation event with user identifier, timestamp, and key metadata
2. WHEN an API key is used for authentication, THE API_Key_System SHALL log the authentication event with key identifier, timestamp, and source IP address
3. WHEN an API key is revoked or expires, THE API_Key_System SHALL log the event with key identifier, timestamp, and reason
4. WHERE an administrator requests audit logs, THE API_Key_System SHALL provide filterable logs of all API key lifecycle events
5. WHEN authentication fails due to an invalid API key, THE API_Key_System SHALL log the failed attempt with the provided key prefix and source IP address

### Requirement 8

**User Story:** As a developer, I want to assign descriptive names to my API keys, so that I can easily identify the purpose of each key

#### Acceptance Criteria

1. WHEN a user creates an API key, THE API_Key_System SHALL allow the user to provide a descriptive name with a maximum length of 100 characters
2. WHEN a user views their API keys, THE API_Key_System SHALL display the descriptive name alongside key metadata
3. WHEN a descriptive name is not provided during creation, THE API_Key_System SHALL generate a default name using the pattern "API Key - [creation timestamp]"
4. WHEN a user updates an API key name, THE API_Key_System SHALL validate that the name is unique within the user's API keys
5. WHERE a user has multiple API keys, THE API_Key_System SHALL enforce unique names to prevent confusion

### Requirement 9

**User Story:** As a user, I want to manage my personal API keys separately from system API keys, so that I have a clear distinction between personal and organizational access

#### Acceptance Criteria

1. WHEN a user accesses the personal API keys section, THE API_Key_System SHALL allow creation of user-level API keys only
2. WHEN a user accesses the personal API keys section, THE API_Key_System SHALL display only API keys owned by that user
3. WHEN an administrator accesses the admin API keys section, THE API_Key_System SHALL allow creation of system-level API keys only
4. WHEN an administrator accesses the admin API keys section, THE API_Key_System SHALL display all system-level API keys across the organization
5. THE API_Key_System SHALL NOT allow creation of user-level API keys from the admin interface to prevent confusion and maintain clear separation of concerns
6. WHEN an administrator creates an API key from the admin interface, THE API_Key_System SHALL NOT display a key type selector since only system-level keys can be created from this interface
