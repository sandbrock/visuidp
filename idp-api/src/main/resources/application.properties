# ============================================================================
# IDP API Configuration
# ============================================================================
# This is the default configuration file for the IDP API.
# For DynamoDB-specific configuration, see application-dynamodb.properties
# For production overrides, see application-prod.properties
# ============================================================================

# Application Configuration
quarkus.application.name=idp-api
quarkus.application.version=1.0.0-SNAPSHOT

# ============================================================================
# Database Provider Configuration
# ============================================================================
# Valid values: postgresql, dynamodb
# Default: postgresql
# Description: Determines which database backend to use for data persistence
#
# To use PostgreSQL (default):
#   - Set DATABASE_PROVIDER=postgresql (or leave unset)
#   - Configure PostgreSQL connection properties below
#
# To use DynamoDB:
#   - Set DATABASE_PROVIDER=dynamodb
#   - Or use the dynamodb profile: -Dquarkus.profile=dynamodb
#   - Configure DynamoDB properties below
# ============================================================================
idp.database.provider=${DATABASE_PROVIDER:postgresql}

# PostgreSQL Database Configuration
# Used when idp.database.provider=postgresql
quarkus.datasource.db-kind=postgresql
quarkus.datasource.username=${DB_USERNAME:idp_user}
quarkus.datasource.password=${DB_PASSWORD:idp_password}
quarkus.datasource.jdbc.url=${DB_URL:jdbc:postgresql://localhost:5432/idp_db}
quarkus.datasource.jdbc.max-size=20
quarkus.datasource.jdbc.min-size=5
quarkus.datasource.jdbc.acquisition-timeout=30
quarkus.datasource.jdbc.idle-removal-interval=2M
quarkus.datasource.jdbc.max-lifetime=15M
quarkus.datasource.jdbc.leak-detection-interval=5M
quarkus.datasource.jdbc.validation-query-sql=SELECT 1
quarkus.datasource.jdbc.background-validation-interval=2M

# DynamoDB Configuration
# Used when idp.database.provider=dynamodb
# AWS Region where DynamoDB tables are located (required for DynamoDB)
idp.database.dynamodb.region=${DYNAMODB_REGION:us-east-1}
# Optional: Custom endpoint for DynamoDB (useful for local testing with DynamoDB Local)
# Example: http://localhost:8000
idp.database.dynamodb.endpoint=${DYNAMODB_ENDPOINT:}
# Optional: AWS credentials (if not using IAM roles)
# idp.database.dynamodb.access-key-id=${AWS_ACCESS_KEY_ID:}
# idp.database.dynamodb.secret-access-key=${AWS_SECRET_ACCESS_KEY:}
# Table name prefix for DynamoDB tables (default: idp)
idp.database.dynamodb.table-prefix=${DYNAMODB_TABLE_PREFIX:idp}

# Default profile: leave schema generation to profile-specific settings.
# Keep SQL logging configurable via LOG_SQL; disable import.sql by default.
quarkus.hibernate-orm.log.sql=${LOG_SQL:false}
quarkus.hibernate-orm.sql-load-script=no-file

# Test profile: run Flyway so tests have the same schema as dev/prod
%test.quarkus.flyway.migrate-at-start=true
%test.quarkus.flyway.clean-at-start=false
%test.quarkus.hibernate-orm.database.generation=none
%test.quarkus.hibernate-orm.sql-load-script=no-file
%test.quarkus.http.test-port=0

# Dev profile: run Flyway migrations automatically
%dev.quarkus.flyway.migrate-at-start=true
%dev.quarkus.flyway.clean-at-start=false
%dev.quarkus.hibernate-orm.schema-management.strategy=validate

# HTTP proxy configuration for Traefik
quarkus.http.proxy.proxy-address-forwarding=true
quarkus.http.proxy.allow-forwarded=true
quarkus.http.proxy.enable-forwarded-host=true
quarkus.http.proxy.enable-forwarded-prefix=true
quarkus.http.proxy.enable-forwarded-proto=true

# CORS configuration
quarkus.http.cors=true
quarkus.http.cors.headers=accept,authorization,content-type,x-requested-with
quarkus.http.cors.methods=GET,POST,PUT,DELETE,OPTIONS,HEAD
quarkus.http.cors.origins=${CORS_ORIGINS:http://localhost:8082,http://localhost:8083,https://localhost:8443,http://localhost:3000}
quarkus.http.cors.access-control-allow-credentials=true
quarkus.http.cors.access-control-max-age=86400

# HTTP Configuration
quarkus.http.port=${HTTP_PORT:8082}
quarkus.http.host=0.0.0.0
quarkus.http.root-path=/api
# OpenAPI/Swagger Configuration
quarkus.smallrye-openapi.info-title=Internal Developer Platform API
quarkus.smallrye-openapi.info-version=1.0.0
quarkus.smallrye-openapi.info-description=RESTful API for provisioning and managing developer projects
quarkus.smallrye-openapi.info-contact-email=support@angryss.com

# Security Configuration
# Authentication is handled by Traefik/OAuth2-Proxy via headers
quarkus.http.auth.basic=false
quarkus.http.auth.proactive=false

# Admin authorization configuration
# Specify the Azure Entra ID group name or ID that should be granted admin role
idp.security.admin-group=${ADMIN_GROUP:IDP-Admins}

# API Key Configuration
idp.api-key.default-expiration-days=90
idp.api-key.rotation-grace-period-hours=24
idp.api-key.max-keys-per-user=10
idp.api-key.bcrypt-cost-factor=12
idp.api-key.key-length=32

# Health Check Configuration
# With root-path, built-ins live under /api/q/*
quarkus.http.auth.permission.health.paths=/api/q/health/*
quarkus.http.auth.permission.health.policy=permit
quarkus.http.auth.permission.metrics.paths=/api/q/metrics/*
quarkus.http.auth.permission.metrics.policy=permit

# Metrics Configuration
quarkus.micrometer.export.prometheus.enabled=true
# Uses default /q/metrics path

# Logging Configuration
quarkus.log.level=INFO
quarkus.log.category."com.angryss.idp".level=${LOG_LEVEL:INFO}
quarkus.log.category."org.hibernate.SQL".level=${LOG_SQL_LEVEL:WARN}
quarkus.log.console.enable=true
quarkus.log.console.format=%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n
