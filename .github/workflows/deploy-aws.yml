name: Deploy to AWS

on:
  workflow_dispatch:

env:
  AWS_REGION: us-west-2
  OPENTOFU_VERSION: 1.8.8

jobs:
  # Build and test all components
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [api, ui, cli]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up build environment
        id: setup
        run: |
          case "${{ matrix.component }}" in
            api)
              echo "build_dir=idp-api" >> $GITHUB_OUTPUT
              echo "artifact_name=api-native-image" >> $GITHUB_OUTPUT
              ;;
            ui)
              echo "build_dir=idp-ui" >> $GITHUB_OUTPUT
              echo "artifact_name=ui-dist" >> $GITHUB_OUTPUT
              ;;
            cli)
              echo "build_dir=idp-cli" >> $GITHUB_OUTPUT
              echo "artifact_name=cli-binary" >> $GITHUB_OUTPUT
              ;;
          esac
      
      # API Build Steps
      - name: Set up Java 21 (API)
        if: matrix.component == 'api'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
      
      - name: Build Quarkus native image (API)
        if: matrix.component == 'api'
        working-directory: idp-api
        run: |
          ./mvnw clean package -Pnative -DskipTests -Dquarkus.profile=lambda
          echo "Native image built successfully"
          ls -lh target/*-runner
      
      - name: Run API tests
        if: matrix.component == 'api'
        working-directory: idp-api
        run: ./mvnw test
      
      - name: Upload API native image
        if: matrix.component == 'api'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.artifact_name }}
          path: idp-api/target/*-runner
          retention-days: 7
      
      # UI Build Steps
      - name: Set up Node.js (UI)
        if: matrix.component == 'ui'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: idp-ui/package-lock.json
      
      - name: Install UI dependencies
        if: matrix.component == 'ui'
        working-directory: idp-ui
        run: npm ci
      
      - name: Run UI tests
        if: matrix.component == 'ui'
        working-directory: idp-ui
        run: npm test
      
      - name: Build React application (UI)
        if: matrix.component == 'ui'
        working-directory: idp-ui
        run: |
          npm run build:prod
          echo "UI build completed"
          ls -lh dist/
      
      - name: Upload UI dist
        if: matrix.component == 'ui'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.artifact_name }}
          path: idp-ui/dist/
          retention-days: 7
      
      # CLI Build Steps
      - name: Set up Rust (CLI)
        if: matrix.component == 'cli'
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Cache Rust dependencies
        if: matrix.component == 'cli'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            idp-cli/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('idp-cli/Cargo.lock') }}
      
      - name: Run CLI tests
        if: matrix.component == 'cli'
        working-directory: idp-cli
        run: cargo test
      
      - name: Build Rust CLI (CLI)
        if: matrix.component == 'cli'
        working-directory: idp-cli
        run: |
          cargo build --release --bin idp-cli-lambda --features lambda
          echo "CLI build completed"
          ls -lh target/release/
      
      - name: Upload CLI binary
        if: matrix.component == 'cli'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.artifact_name }}
          path: idp-cli/target/release/idp-cli-lambda
          retention-days: 7
  
  # Package container images
  package:
    name: Package Container Images
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        component: [api, cli]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.component == 'api' && 'api-native-image' || 'cli-binary' }}
          path: ${{ matrix.component == 'api' && 'idp-api/target' || 'idp-cli/target/release' }}
      
      - name: Make binary executable
        run: |
          if [ "${{ matrix.component }}" == "api" ]; then
            chmod +x idp-api/target/*-runner
          else
            chmod +x idp-cli/target/release/idp-cli-lambda
          fi
      
      - name: Set image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.environment }}-${{ github.sha }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "tag=prod-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "tag=dev-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Build and push Docker image
        working-directory: ${{ matrix.component == 'api' && 'idp-api' || 'idp-cli' }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: idp-${{ matrix.component }}-lambda
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          docker build -f Dockerfile.lambda -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          # Also tag as latest for the branch
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
  
  # Deploy with OpenTofu
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: package
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'prod' || 'dev') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}
      
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: OpenTofu Init
        working-directory: terraform
        run: |
          tofu init \
            -backend-config="key=visuidp/aws-deployment/${{ steps.env.outputs.environment }}/terraform.tfstate"
      
      - name: OpenTofu Plan
        working-directory: terraform
        run: |
          tofu plan \
            -var-file="${{ steps.env.outputs.environment }}.tfvars" \
            -var="image_tag=${{ github.sha }}" \
            -out=tfplan
      
      - name: OpenTofu Apply
        working-directory: terraform
        if: github.event_name != 'pull_request'
        run: tofu apply -auto-approve tfplan
      
      - name: Get OpenTofu Outputs
        id: tf-outputs
        working-directory: terraform
        if: github.event_name != 'pull_request'
        run: |
          echo "api_url=$(tofu output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$(tofu output -raw cloudfront_url)" >> $GITHUB_OUTPUT
          echo "s3_bucket=$(tofu output -raw ui_bucket_name)" >> $GITHUB_OUTPUT
          echo "cloudfront_distribution=$(tofu output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT
      
      - name: Download UI dist
        if: github.event_name != 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: idp-ui/dist
      
      - name: Deploy UI to S3
        if: github.event_name != 'pull_request'
        working-directory: idp-ui
        env:
          S3_BUCKET: ${{ steps.tf-outputs.outputs.s3_bucket }}
          CLOUDFRONT_DIST: ${{ steps.tf-outputs.outputs.cloudfront_distribution }}
        run: |
          chmod +x deploy-to-s3.sh
          ./deploy-to-s3.sh \
            --bucket "$S3_BUCKET" \
            --distribution "$CLOUDFRONT_DIST" \
            --skip-build
      
      - name: Save deployment info
        if: github.event_name != 'pull_request'
        run: |
          echo "Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: ${{ steps.tf-outputs.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront URL**: ${{ steps.tf-outputs.outputs.cloudfront_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
  
  # Run smoke tests
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}
          tofu_wrapper: false
      
      - name: Get deployment URLs
        id: urls
        working-directory: terraform
        run: |
          tofu init -backend-config="key=visuidp/aws-deployment/${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}/terraform.tfstate"
          echo "api_url=$(tofu output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$(tofu output -raw cloudfront_url)" >> $GITHUB_OUTPUT
      
      - name: Run smoke tests
        env:
          API_URL: ${{ steps.urls.outputs.api_url }}
          UI_URL: ${{ steps.urls.outputs.cloudfront_url }}
        run: |
          chmod +x scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh
      
      - name: Report test results
        if: always()
        run: |
          if [ -f smoke-test-results.txt ]; then
            cat smoke-test-results.txt >> $GITHUB_STEP_SUMMARY
          fi
